name: 'Architecture Review POC - Copilot Analysis'

# This workflow creates an issue asking Copilot to review architecture documentation
on:
  workflow_dispatch:
    inputs:
      message:
        description: 'Custom context or focus area for the review (optional)'
        required: false
        default: 'General architecture alignment review'
        type: string

# Grant permissions needed to create and assign issues
permissions:
  contents: read
  issues: write

jobs:
  test-architecture-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Create Architecture Review Issue for Copilot
        id: create-issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const currentTime = new Date().toLocaleString();
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“‹ Architecture Documentation Review - ${currentTime}`,
              body: `## ğŸ“‹ Architecture Documentation Review Request

**Triggered at**: ${currentTime}
**Workflow run**: ${{ github.run_id }}
**Focus area**: ${{ inputs.message }}

---

@github-copilot Hello! ğŸ‘‹

I need you to review the current **ARCHITECTURE.md** documentation against the actual codebase in this repository to identify any discrepancies or needed updates.

## ğŸ“‹ **Your Task:**

1. **Read the ARCHITECTURE.md file** in the repository root
2. **Analyze the current codebase structure** (especially the \`src-v2/\` directory)
3. **Compare the documentation against the actual code** 
4. **Identify any gaps, inaccuracies, or needed updates**

## ğŸ¯ **What to look for:**

- **File paths and structure** - Are the documented paths correct?
- **Service/controller methods** - Do the documented methods exist?
- **Dependencies and integrations** - Are external APIs and libraries accurate?
- **Architecture patterns** - Does the actual code match the documented architecture?
- **Missing components** - Are there new files/services not documented?

## ğŸ“ **Expected Output:**

Please create a PR with either:

**Option A:** If changes are needed:
- Update the ARCHITECTURE.md file with corrections
- Document any new components or changes
- Explain what was outdated and how you fixed it

**Option B:** If no changes are needed:
- Create a simple \`ARCHITECTURE_REVIEW_${currentTime.replace(/[^0-9]/g, '')}.md\` file
- Document that you reviewed the architecture
- Confirm alignment between docs and code
- Note the review date and any observations

---

**Repository Context:**
- Main backend code: \`src-v2/\` directory
- Frontend code: \`public/js/modules/\` directory  
- Configuration: \`config/\` directory
- This is a Node.js app with PowerBI integration and OpenAI chat

**Goal:** Keep our architecture documentation accurate and up-to-date!`,
              
              labels: [
                'documentation',
                'architecture',
                'copilot-review',
                'automated-analysis'
              ]
            });

            console.log(`âœ… Created architecture review issue #${issue.data.number}`);
            console.log(`ğŸ”— Issue URL: ${issue.data.html_url}`);
            console.log(`ğŸ¤– Next: Manually assign this issue to Copilot via GitHub UI`);
            console.log(`â° Created at: ${currentTime}`);

            // Output the issue URL for easy access
            core.setOutput('issue-url', issue.data.html_url);
            core.setOutput('issue-number', issue.data.number);
            
      - name: Display Results
        run: |
          echo "ğŸ‰ Architecture Review Issue Created!"
          echo "ğŸ“‹ Issue Number: ${{ steps.create-issue.outputs.issue-number }}"
          echo "ğŸ”— Issue URL: ${{ steps.create-issue.outputs.issue-url }}"
          echo ""
          echo "âœ‹ MANUAL STEP REQUIRED:"
          echo "1. Visit the issue URL above"
          echo "2. Click on 'Assignees' in the right sidebar"
          echo "3. Assign the issue to 'Copilot' from the dropdown"
          echo ""
          echo "ğŸ” What Copilot will do:"
          echo "1. Acknowledge with ğŸ‘€ emoji"
          echo "2. Read ARCHITECTURE.md and analyze the codebase"
          echo "3. Create a PR with updates or confirmation report"
          echo "4. Compare documented vs actual file structure"
          echo ""
          echo "ğŸ“ This tests Copilot's code analysis and documentation skills!"